{{ define "title" }}RepLog — {{ .Program.Name }}{{ end }}

{{ define "content" }}
        <div class="breadcrumb">
            <a href="/programs">Programs</a> &rsaquo; {{ .Program.Name }}
        </div>

        <div class="page-header">
            <hgroup>
                <h1>{{ .Program.Name }}</h1>
                {{ if .Program.Description.Valid }}<p>{{ .Program.Description.String }}</p>{{ end }}
            </hgroup>
            <div class="page-actions">
                <a href="/programs/{{ .Program.ID }}/edit" role="button" class="outline secondary">Edit</a>
                <form method="POST" action="/programs/{{ .Program.ID }}/delete" class="inline"
                      hx-confirm="Delete {{ .Program.Name }}? This will remove all prescribed sets.">
                    <button type="submit" class="outline contrast">Delete</button>
                </form>
            </div>
        </div>

        <p class="text-muted">{{ .Program.NumWeeks }} week{{ if ne .Program.NumWeeks 1 }}s{{ end }} per cycle · {{ .Program.NumDays }} day{{ if ne .Program.NumDays 1 }}s{{ end }}/week
            · {{ .Program.AthleteCount }} athlete{{ if ne .Program.AthleteCount 1 }}s{{ end }} assigned{{ if .Program.IsLoop }} · <mark>Continuous loop</mark>{{ end }}</p>

        <!-- Week Tabs -->
        {{ if gt .Program.NumWeeks 1 }}
        <nav class="week-tabs" role="tablist">
            {{ range .WeekTabs }}
            <a href="/programs/{{ $.Program.ID }}?week={{ .Week }}" role="tab"
               class="week-tab{{ if .Active }} active{{ end }}"
               {{ if .Active }}aria-selected="true"{{ end }}>
                Week {{ .Week }}
                {{ if gt .SetCount 0 }}<span class="tab-badge">{{ .SetCount }}</span>{{ end }}
            </a>
            {{ end }}
        </nav>
        {{ end }}

        <!-- Days for Current Week -->
        {{ range .Days }}
        <details class="day-section"{{ if .Sets }} open{{ end }}>
            <summary>
                <span class="day-title">Day {{ .Day }}</span>
                <span class="day-meta">{{ len .Sets }} set{{ if ne (len .Sets) 1 }}s{{ end }}</span>
            </summary>

            {{ if .Sets }}
            <table class="striped">
                <thead>
                    <tr>
                        <th scope="col">Exercise</th>
                        <th scope="col">Order</th>
                        <th scope="col">Set</th>
                        <th scope="col">Reps</th>
                        <th scope="col">Intensity</th>
                        <th scope="col">Notes</th>
                        <th scope="col"></th>
                    </tr>
                </thead>
                <tbody>
                    {{ range .Sets }}
                    <tr>
                        <td>{{ .ExerciseName }}</td>
                        <td>{{ .SortOrder }}</td>
                        <td>{{ .SetNumber }}</td>
                        <td>{{ .RepsLabel }}</td>
                        <td>{{ if .Percentage.Valid }}{{ printf "%.0f" .Percentage.Float64 }}%{{ else }}{{ .AbsoluteWeightLabel }}{{ end }}</td>
                        <td>{{ if .Notes.Valid }}{{ .Notes.String }}{{ else }}<span class="text-muted">—</span>{{ end }}</td>
                        <td>
                            <form method="POST" action="/programs/{{ $.Program.ID }}/sets/{{ .ID }}/delete?week={{ $.CurrentWeek }}" class="inline">
                                <button type="submit" class="outline contrast">✕</button>
                            </form>
                        </td>
                    </tr>
                    {{ end }}
                </tbody>
            </table>
            {{ else }}
            <p class="text-muted">No sets prescribed yet.</p>
            {{ end }}

            <!-- Inline Add Set Form -->
            {{ if $.User.IsCoach }}
            <form method="POST" action="/programs/{{ $.Program.ID }}/sets" class="add-set-inline">
                <input type="hidden" name="week" value="{{ $.CurrentWeek }}">
                <input type="hidden" name="day" value="{{ .Day }}">
                <div class="grid">
                    <label for="exercise_id_d{{ .Day }}">Exercise
                        <select id="exercise_id_d{{ .Day }}" name="exercise_id" required>
                            <option value="">Select…</option>
                            {{ range $.Exercises }}
                            <option value="{{ .ID }}">{{ .Name }}{{ if .Tier.Valid }} ({{ tierLabel .Tier.String }}){{ end }}</option>
                            {{ end }}
                        </select>
                    </label>
                    <label for="set_number_d{{ .Day }}">Set #
                        <input type="number" id="set_number_d{{ .Day }}" name="set_number" min="1" required value="{{ .NextSet }}">
                    </label>
                    <label for="reps_d{{ .Day }}">Reps
                        <input type="number" id="reps_d{{ .Day }}" name="reps" min="0" placeholder="AMRAP">
                    </label>
                    <label for="pct_d{{ .Day }}">% TM
                        <input type="number" id="pct_d{{ .Day }}" name="percentage" min="0" max="200" step="0.5" placeholder="e.g. 75">
                    </label>
                    <label for="abs_wt_d{{ .Day }}">Fixed Weight
                        <input type="number" id="abs_wt_d{{ .Day }}" name="absolute_weight" min="0" step="0.5" placeholder="e.g. 25">
                    </label>
                    <label for="sort_d{{ .Day }}">Order
                        <input type="number" id="sort_d{{ .Day }}" name="sort_order" min="0" value="0" placeholder="0">
                    </label>
                    <label for="notes_d{{ .Day }}">Notes
                        <input type="text" id="notes_d{{ .Day }}" name="notes" placeholder="Optional">
                    </label>
                </div>
                <button type="submit" class="outline secondary">+ Add Set</button>
            </form>
            {{ end }}
        </details>
        {{ end }}

        <!-- Progression Rules -->
        {{ if or $.User.IsCoach $.User.IsAdmin }}
        <details{{ if .ProgressionRules }} open{{ end }}>
            <summary><strong>Progression Rules</strong> <span class="text-muted">(TM increments per cycle)</span></summary>

            {{ if .ProgressionRules }}
            <table class="striped">
                <thead>
                    <tr>
                        <th scope="col">Exercise</th>
                        <th scope="col">Increment</th>
                        <th scope="col"></th>
                    </tr>
                </thead>
                <tbody>
                    {{ range .ProgressionRules }}
                    <tr>
                        <td>{{ .ExerciseName }}</td>
                        <td>+{{ .IncrementLabel }}</td>
                        <td>
                            <form method="POST" action="/programs/{{ $.Program.ID }}/progression/{{ .ID }}/delete" class="inline">
                                <button type="submit" class="outline contrast">✕</button>
                            </form>
                        </td>
                    </tr>
                    {{ end }}
                </tbody>
            </table>
            {{ else }}
            <p class="text-muted">No progression rules yet. Add one below to suggest TM bumps at cycle boundaries.</p>
            {{ end }}

            <form method="POST" action="/programs/{{ .Program.ID }}/progression" class="add-set-inline">
                <div class="grid">
                    <label for="prog_exercise_id">Exercise
                        <select id="prog_exercise_id" name="exercise_id" required>
                            <option value="">Select…</option>
                            {{ range .Exercises }}
                            <option value="{{ .ID }}">{{ .Name }}</option>
                            {{ end }}
                        </select>
                    </label>
                    <label for="prog_increment">Increment per cycle
                        <input type="number" id="prog_increment" name="increment" min="0.5" step="0.5" required placeholder="e.g. 5">
                    </label>
                </div>
                <button type="submit" class="outline secondary">+ Add Rule</button>
            </form>
        </details>
        {{ end }}
{{ end }}
