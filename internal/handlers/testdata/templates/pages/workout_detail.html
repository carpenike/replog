{{ define "title" }}{{ appName }} — Workout {{ formatDateStr .Prefs .Workout.Date }}{{ end }}

{{ define "content" }}
        <div class="breadcrumb">
            <a href="/athletes">Athletes</a> &rsaquo; <a href="/athletes/{{ .Athlete.ID }}">{{ .Athlete.Name }}</a> &rsaquo; <a href="/athletes/{{ .Athlete.ID }}/workouts">Workouts</a> &rsaquo; {{ formatDateStr .Prefs .Workout.Date }}
        </div>

        <div class="page-header">
            <hgroup>
                <h1>{{ formatDateStr .Prefs .Workout.Date }}</h1>
                <p>{{ .Athlete.Name }} &mdash; {{ .Workout.SetCount }} sets logged</p>
            </hgroup>
            {{ if .User.IsCoach }}
            <div class="page-actions">
                <form method="POST" action="/athletes/{{ .Athlete.ID }}/workouts/{{ .Workout.ID }}/delete" class="inline"
                      hx-confirm="Delete this workout and all its sets?">
                    <button type="submit" class="outline contrast">Delete Workout</button>
                </form>
            </div>
            {{ end }}
        </div>

        <!-- Workout Notes -->
        <details>
            <summary>Session Notes</summary>
            <form method="POST" action="/athletes/{{ .Athlete.ID }}/workouts/{{ .Workout.ID }}/notes">
                <label for="notes">
                    <textarea id="notes" name="notes" rows="2" placeholder="Add session-level notes">{{ if .Workout.Notes.Valid }}{{ .Workout.Notes.String }}{{ end }}</textarea>
                </label>
                <button type="submit" class="outline secondary">Save Notes</button>
            </form>
        </details>

        <!-- Log a Set -->
        <section>
            <h2>Log a Set</h2>

            {{ if .SetError }}
            <div class="alert alert-error" role="alert">{{ .SetError }}</div>
            {{ end }}

            {{ if and .Prescription .Prescription.Lines }}
            <!-- Program progress -->
            <div class="program-progress">
                <strong>{{ .Prescription.Program.TemplateName }}</strong> · Cycle {{ .Prescription.CycleNumber }}, Week {{ .Prescription.CurrentWeek }}, Day {{ .Prescription.CurrentDay }}
            </div>

            <!-- Per-set scaffold -->
            {{ range $line := .Prescription.Lines }}
            {{ $loggedCount := index $.LoggedSetCounts $line.ExerciseID }}
            {{ $totalSets := len $line.Sets }}
            <details{{ if lt $loggedCount $totalSets }} open{{ end }} class="scaffold-exercise">
                <summary>
                    <strong>{{ $line.ExerciseName }}</strong>
                    {{ $tm := index $.TMByExercise $line.ExerciseID }}{{ if $tm }}<span class="text-muted">TM: {{ formatWeight $tm.Weight }} {{ weightUnit $.Prefs }}</span>{{ end }}
                    <span class="scaffold-progress{{ if ge $loggedCount $totalSets }} complete{{ end }}">{{ $loggedCount }}/{{ $totalSets }} sets</span>
                </summary>
                {{ if ge $loggedCount $totalSets }}
                <p class="scaffold-complete">&#10003; All sets complete</p>
                {{ else }}
                {{ range $i, $s := $line.Sets }}
                {{ if ge $i $loggedCount }}
                <form method="POST" action="/athletes/{{ $.Athlete.ID }}/workouts/{{ $.Workout.ID }}/sets" class="scaffold-set-form">
                    <input type="hidden" name="exercise_id" value="{{ $line.ExerciseID }}">
                    <input type="hidden" name="rep_type" value="{{ $s.RepType }}">
                    <div class="scaffold-grid">
                        <span class="scaffold-target">Set {{ $s.SetNumber }}: {{ $s.RepsLabel }} reps{{ if $s.PercentageLabel }} @ {{ $s.PercentageLabel }}{{ end }}{{ if $s.TargetWeightLabel }}{{ if eq $s.TargetWeightLabel "BW" }} &rarr; BW{{ else }} &rarr; {{ $s.TargetWeightLabel }} {{ weightUnit $.Prefs }}{{ end }}{{ end }}</span>
                        <label class="field-sm">Reps
                            <input type="number" name="reps" min="1" required value="{{ if $s.Reps.Valid }}{{ $s.Reps.Int64 }}{{ end }}" inputmode="numeric">
                        </label>
                        <label class="field-sm">Weight
                            <input type="number" name="weight" step="0.5" min="0" value="{{ if and $s.TargetWeightLabel (ne $s.TargetWeightLabel "BW") }}{{ $s.TargetWeightLabel }}{{ end }}" inputmode="numeric">
                        </label>
                        <label class="field-sm">RPE
                            <input type="number" name="rpe" step="0.5" min="1" max="10" inputmode="numeric">
                        </label>
                        <button type="submit" class="outline secondary scaffold-log-btn">Log</button>
                    </div>
                </form>
                {{ end }}
                {{ end }}
                {{ end }}
            </details>
            {{ end }}

            <button type="button" id="unscripted-toggle" class="outline secondary" onclick="document.getElementById('unscripted-form').hidden=false;this.hidden=true">+ Add Unscripted Set</button>
            <div id="unscripted-form" hidden>
            {{ else if .Assigned }}
            <details>
                <summary>Prescribed Exercises</summary>
                <table class="striped">
                    <thead>
                        <tr>
                            <th scope="col">Exercise</th>
                            <th scope="col">Target Reps</th>
                            <th scope="col">Training Max</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{ range .Assigned }}
                        <tr>
                            <td>{{ .ExerciseName }}</td>
                            <td>{{ if .TargetReps.Valid }}{{ .TargetReps.Int64 }}{{ else }}<span class="text-muted">—</span>{{ end }}</td>
                            <td>{{ $tm := index $.TMByExercise .ExerciseID }}{{ if $tm }}{{ formatWeight $tm.Weight }} {{ weightUnit $.Prefs }}{{ else }}<span class="text-muted">—</span>{{ end }}</td>
                        </tr>
                        {{ end }}
                    </tbody>
                </table>
            </details>
            {{ end }}

            <form method="POST" action="/athletes/{{ .Athlete.ID }}/workouts/{{ .Workout.ID }}/sets">
                <div class="log-set-grid">
                    <label for="exercise_id">Exercise
                        <select id="exercise_id" name="exercise_id" required>
                            <option value="">— Select —</option>
                            {{ if .Assigned }}
                            <optgroup label="Assigned">
                                {{ range .Assigned }}
                                <option value="{{ .ExerciseID }}">{{ .ExerciseName }}{{ if .TargetReps.Valid }} ({{ .TargetReps.Int64 }} reps){{ end }}{{ $tm := index $.TMByExercise .ExerciseID }}{{ if $tm }} — TM: {{ formatWeight $tm.Weight }} {{ weightUnit $.Prefs }}{{ end }}</option>
                                {{ end }}
                            </optgroup>
                            {{ end }}
                            {{ if .Unassigned }}
                            <optgroup label="All Exercises">
                                {{ range .Unassigned }}
                                <option value="{{ .ID }}">{{ .Name }}</option>
                                {{ end }}
                            </optgroup>
                            {{ end }}
                        </select>
                    </label>
                    <label for="reps" class="field-sm">Reps
                        <input type="number" id="reps" name="reps" min="1" required placeholder="0" inputmode="numeric">
                    </label>
                    <label for="weight" class="field-sm">Weight ({{ weightUnit .Prefs }})
                        <input type="number" id="weight" name="weight" step="0.5" min="0" placeholder="{{ weightUnit .Prefs }}" inputmode="numeric">
                    </label>
                    <label for="rpe" class="field-sm">RPE
                        <input type="number" id="rpe" name="rpe" step="0.5" min="1" max="10" placeholder="1-10" inputmode="numeric">
                    </label>
                </div>
                <label for="set_notes">Notes
                    <input type="text" id="set_notes" name="notes" placeholder="Optional per-set note">
                </label>
                <div class="unscripted-form-actions">
                    <button type="submit" aria-busy="false">Log Set</button>
                    <button type="button" class="outline contrast" onclick="document.getElementById('unscripted-form').hidden=true;document.getElementById('unscripted-toggle').hidden=false">Cancel</button>
                </div>
            </form>

            {{ if and .Prescription .Prescription.Lines }}
            </div>
            {{ end }}
        </section>

        <!-- Rest Timer -->
        <div id="rest-timer" class="rest-timer" style="display:none;">
            <div class="timer-bar">
                <div class="timer-progress"></div>
            </div>
            <div class="timer-controls">
                <span class="timer-display">0:00</span>
                <button type="button" class="timer-toggle outline secondary">Pause</button>
                <button type="button" class="timer-reset outline secondary">Reset</button>
                <button type="button" class="timer-dismiss outline contrast">✕</button>
            </div>
        </div>

        <!-- Logged Sets -->
        {{ if .Groups }}
        <section>
            <h2>Logged Sets</h2>
            {{ range .Groups }}
            <details open class="exercise-group">
                <summary><strong>{{ .ExerciseName }}</strong> <span class="text-muted">({{ len .Sets }} sets)</span></summary>
                <table class="striped">
                    <thead>
                        <tr>
                            <th scope="col">Set</th>
                            <th scope="col">Reps</th>
                            <th scope="col">Weight</th>
                            <th scope="col">RPE</th>
                            <th scope="col">Notes</th>
                            <th scope="col"></th>
                        </tr>
                    </thead>
                    <tbody>
                        {{ range .Sets }}
                        <tr>
                            <td>{{ .SetNumber }}</td>
                            <td>{{ .Reps }}</td>
                            <td>{{ if .Weight.Valid }}{{ formatWeight .Weight.Float64 }} {{ weightUnit $.Prefs }}{{ else }}<span class="text-muted">BW</span>{{ end }}</td>
                            <td>{{ if .RPE.Valid }}{{ .RPE.Float64 }}{{ else }}<span class="text-muted">—</span>{{ end }}</td>
                            <td>{{ if .Notes.Valid }}{{ .Notes.String }}{{ else }}<span class="text-muted">—</span>{{ end }}</td>
                            <td class="set-actions">
                                <a href="/athletes/{{ $.Athlete.ID }}/workouts/{{ $.Workout.ID }}/sets/{{ .ID }}/edit" role="button" class="outline secondary">Edit</a>
                                <form method="POST" action="/athletes/{{ $.Athlete.ID }}/workouts/{{ $.Workout.ID }}/sets/{{ .ID }}/delete" class="inline"
                                      hx-confirm="Delete this set?">
                                    <button type="submit" class="outline contrast">✕</button>
                                </form>
                            </td>
                        </tr>
                        {{ end }}
                    </tbody>
                </table>
            </details>
            {{ end }}
        </section>
        {{ end }}

        <script src="/static/js/rest-timer.js"></script>
{{ end }}
