{{ define "title" }}{{ appName }} â€” Preferences{{ end }}

{{ define "content" }}
        <div class="breadcrumb">
            <a href="/">Home</a> &rsaquo; Preferences
        </div>

        <h1>Preferences</h1>

        {{ if .Success }}
        <div class="alert alert-success" role="alert">Preferences saved successfully.</div>
        {{ end }}

        {{ if .Error }}
        <div class="alert alert-error" role="alert">{{ .Error }}</div>
        {{ end }}

        <section>
            <h2>Avatar</h2>
            <div class="avatar-settings">
                <div class="avatar-preview">
                    {{ if and .AvatarUser .AvatarUser.HasAvatar }}
                    <img src="{{ .AvatarUser.AvatarURL }}" alt="Your avatar" class="avatar-img avatar-img--lg">
                    {{ else }}
                    <div class="avatar-placeholder avatar-placeholder--lg">{{ userInitials (displayName .User) }}</div>
                    {{ end }}
                </div>
                <div class="avatar-actions">
                    <form method="POST" action="/avatars/upload" enctype="multipart/form-data">
                        {{ if .CSRFToken }}<input type="hidden" name="csrf_token" value="{{ .CSRFToken }}">{{ end }}
                        <label for="avatar" class="avatar-file-label">
                            Choose Image
                            <input type="file" id="avatar" name="avatar" accept="image/jpeg,image/png,image/gif,image/webp" class="avatar-file-input" data-auto-submit>
                        </label>
                        <small>JPEG, PNG, GIF, or WebP. Max 2 MB.</small>
                    </form>
                    {{ if and .AvatarUser .AvatarUser.HasAvatar }}
                    <form method="POST" action="/avatars/delete" class="mt-md">
                        {{ if .CSRFToken }}<input type="hidden" name="csrf_token" value="{{ .CSRFToken }}">{{ end }}
                        <button type="submit" class="outline secondary">Remove Avatar</button>
                    </form>
                    {{ end }}
                </div>
            </div>
        </section>

        <hr>

        <form method="POST" action="/preferences">
            <label for="weight_unit">Weight Unit
                <select id="weight_unit" name="weight_unit">
                    {{ $currentUnit := "" }}
                    {{ if .EditPrefs }}{{ $currentUnit = .EditPrefs.WeightUnit }}{{ end }}
                    {{ range .WeightUnits }}
                    <option value="{{ . }}" {{ if eq . $currentUnit }}selected{{ end }}>{{ . }}</option>
                    {{ end }}
                </select>
            </label>

            <label for="timezone">Timezone
                <select id="timezone" name="timezone">
                    {{ $currentTZ := "" }}
                    {{ if .EditPrefs }}{{ $currentTZ = .EditPrefs.Timezone }}{{ end }}
                    {{ range .CommonTimezones }}
                    <option value="{{ . }}" {{ if eq . $currentTZ }}selected{{ end }}>{{ . }}</option>
                    {{ end }}
                </select>
            </label>

            <label for="date_format">Date Format
                <select id="date_format" name="date_format">
                    {{ $currentFmt := "" }}
                    {{ if .EditPrefs }}{{ $currentFmt = .EditPrefs.DateFormat }}{{ end }}
                    {{ range $format, $label := .DateFormats }}
                    <option value="{{ $format }}" {{ if eq $format $currentFmt }}selected{{ end }}>{{ $label }}</option>
                    {{ end }}
                </select>
            </label>

            <div class="form-actions">
                <button type="submit">Save Preferences</button>
                <a href="/" role="button" class="secondary">Cancel</a>
            </div>
        </form>

        <hr>

        <section data-passkey>
            <h2>Passkeys</h2>
            <p>Register Face ID, Touch ID, or a security key for passwordless sign-in.</p>

            <div id="passkeys-list">
                {{ if .Passkeys }}
                <table>
                    <thead>
                        <tr>
                            <th scope="col">Label</th>
                            <th scope="col">Registered</th>
                            <th scope="col"></th>
                        </tr>
                    </thead>
                    <tbody>
                        {{ range .Passkeys }}
                        <tr>
                            <td>{{ if .Label.Valid }}{{ .Label.String }}{{ else }}<em>Unnamed</em>{{ end }}</td>
                            <td>{{ .CreatedAt.Format "Jan 2, 2006" }}</td>
                            <td>
                                <form method="POST"
                                      action="/users/{{ $.UserID }}/passkeys/{{ .ID }}/delete"
                                      hx-post="/users/{{ $.UserID }}/passkeys/{{ .ID }}/delete"
                                      hx-target="#passkeys-list"
                                      hx-swap="innerHTML"
                                      hx-confirm="Remove this passkey?">
                                    {{ if $.CSRFToken }}<input type="hidden" name="csrf_token" value="{{ $.CSRFToken }}">{{ end }}
                                    <button type="submit" class="outline secondary">Remove</button>
                                </form>
                            </td>
                        </tr>
                        {{ end }}
                    </tbody>
                </table>
                {{ else }}
                <p><em>No passkeys registered yet.</em></p>
                {{ end }}
            </div>

            <div class="flex-row">
                <input type="text" id="passkey-label" placeholder="Label (e.g. iPad)" aria-label="Passkey label" class="input-flex mb-0">
                <button type="button" class="btn-inline"
                        data-action="passkey-register">
                    Register Passkey
                </button>
            </div>
            <small id="passkey-register-status" class="passkey-status"></small>
        </section>
        <script src="/static/js/passkeys.js"></script>
{{ end }}
