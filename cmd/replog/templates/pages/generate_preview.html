{{ define "title" }}RepLog &mdash; AI Coach Preview{{ end }}

{{ define "content" }}
        <div class="breadcrumb">
            <a href="/athletes/{{ .Athlete.ID }}">{{ .Athlete.Name }}</a> &rsaquo;
            <a href="/athletes/{{ .Athlete.ID }}/programs/generate">AI Coach</a> &rsaquo; Preview
        </div>

        <div class="page-header">
            <h1>Generated Program Preview</h1>
        </div>

        {{ if .Result.Reasoning }}
        <article>
            <header>
                <h3>AI Coach Reasoning</h3>
            </header>
            <div class="reasoning-text">
                <p>{{ .Result.Reasoning }}</p>
            </div>
            <footer>
                <small>Model: {{ .Result.Model }} &middot; {{ .Result.TokensUsed }} tokens &middot; {{ .Result.Duration }}</small>
            </footer>
        </article>
        {{ end }}

        <article>
            <header>
                <h3>Import Summary</h3>
            </header>
            <table>
                <thead>
                    <tr>
                        <th>Entity</th>
                        <th>New</th>
                        <th>Mapped to Existing</th>
                    </tr>
                </thead>
                <tbody>
                    {{ if or .Preview.EquipmentNew .Preview.EquipmentMapped }}
                    <tr>
                        <td>Equipment</td>
                        <td>{{ .Preview.EquipmentNew }}</td>
                        <td>{{ .Preview.EquipmentMapped }}</td>
                    </tr>
                    {{ end }}
                    {{ if or .Preview.ExercisesNew .Preview.ExercisesMapped }}
                    <tr>
                        <td>Exercises</td>
                        <td>{{ .Preview.ExercisesNew }}</td>
                        <td>{{ .Preview.ExercisesMapped }}</td>
                    </tr>
                    {{ end }}
                    {{ if or .Preview.ProgramsNew .Preview.ProgramsMapped }}
                    <tr>
                        <td>Programs</td>
                        <td>{{ .Preview.ProgramsNew }}</td>
                        <td>{{ .Preview.ProgramsMapped }}</td>
                    </tr>
                    {{ end }}
                </tbody>
            </table>
        </article>

        {{ if .Mapping.Programs }}
        <article>
            <header>
                <h3>Programs</h3>
            </header>
            {{ range .Mapping.Programs }}
            <p>{{ if .Create }}<strong>New:</strong>{{ else }}<strong>Update:</strong>{{ end }} {{ .ImportName }}</p>
            {{ end }}
        </article>
        {{ end }}

        {{ if .Mapping.Exercises }}
        <article>
            <header>
                <h3>Exercises</h3>
            </header>
            <table>
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {{ range .Mapping.Exercises }}
                    <tr>
                        <td>{{ .ImportName }}</td>
                        <td>{{ if .Create }}Create new{{ else }}Map to: {{ .MappedName }}{{ end }}</td>
                    </tr>
                    {{ end }}
                </tbody>
            </table>
        </article>
        {{ end }}

        {{ if .ProgramDays }}
        {{ with index .ProgramDays 0 }}
        {{ if .Description }}
        <article>
            <header><h3>{{ .ProgramName }}</h3></header>
            <p>{{ .Description }}</p>
            <small>{{ .NumDays }} days/week{{ if .IsLoop }}, looping{{ else }}, {{ .NumWeeks }} weeks{{ end }}</small>
        </article>
        {{ end }}
        {{ end }}

        <form method="POST" action="/athletes/{{ .Athlete.ID }}/programs/generate/preview"
              hx-boost="false">
            <input type="hidden" name="csrf_token" value="{{ .CSRFToken }}">
            <input type="hidden" name="set_count" value="{{ len .EditableRows }}">

            {{ range .ProgramDays }}
            <article>
                <header>
                    <h3>{{ if gt .NumWeeks 1 }}Week {{ .Week }} &mdash; {{ end }}Day {{ .Day }}</h3>
                </header>
                <div class="table-scroll">
                <table class="striped">
                    <thead>
                        <tr>
                            <th>Exercise</th>
                            <th>Sets</th>
                            <th>Reps</th>
                            <th>Load</th>
                            <th>Notes</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{ $week := .Week }}{{ $day := .Day }}
                        {{ range $.EditableRows }}{{ if and (eq .Week $week) (eq .Day $day) }}
                        <tr>
                            <td>
                                <input type="text" name="set_{{ .Index }}_exercise" value="{{ .Exercise }}" class="preview-input">
                                <input type="hidden" name="set_{{ .Index }}_program_idx" value="{{ .ProgramIdx }}">
                                <input type="hidden" name="set_{{ .Index }}_week" value="{{ .Week }}">
                                <input type="hidden" name="set_{{ .Index }}_day" value="{{ .Day }}">
                                <input type="hidden" name="set_{{ .Index }}_sort_order" value="{{ .SortOrder }}">
                                <input type="hidden" name="set_{{ .Index }}_rep_type" value="{{ .RepType }}">
                            </td>
                            <td class="preview-col-sets">
                                <input type="number" name="set_{{ .Index }}_num_sets" value="{{ .NumSets }}" min="1" max="20" class="preview-input">
                            </td>
                            <td class="preview-col-reps">
                                <input type="text" name="set_{{ .Index }}_reps" value="{{ .Reps }}" placeholder="AMRAP" class="preview-input">
                                {{ if .AmrapLast }}
                                <label class="text-xs"><input type="checkbox" name="set_{{ .Index }}_amrap_last" value="1" checked class="mb-0"> +AMRAP</label>
                                {{ else }}
                                <label class="text-xs"><input type="checkbox" name="set_{{ .Index }}_amrap_last" value="1" class="mb-0"> +AMRAP</label>
                                {{ end }}
                            </td>
                            <td class="preview-col-load">
                                <select name="set_{{ .Index }}_load_type" class="preview-select">
                                    <option value="percent"{{ if eq .LoadType "percent" }} selected{{ end }}>% TM</option>
                                    <option value="absolute"{{ if eq .LoadType "absolute" }} selected{{ end }}>lbs</option>
                                    <option value="bodyweight"{{ if eq .LoadType "bodyweight" }} selected{{ end }}>BW</option>
                                </select>
                                {{ if ne .LoadType "bodyweight" }}
                                <input type="text" name="set_{{ .Index }}_load_value" value="{{ .LoadValue }}" class="preview-input">
                                {{ else }}
                                <input type="text" name="set_{{ .Index }}_load_value" value="" class="preview-input" placeholder="&mdash;">
                                {{ end }}
                            </td>
                            <td>
                                <input type="text" name="set_{{ .Index }}_notes" value="{{ .Notes }}" class="preview-input">
                            </td>
                            <td class="preview-col-del">
                                <label class="text-xs"><input type="checkbox" name="set_{{ .Index }}_delete" value="1"> Del</label>
                            </td>
                        </tr>
                        {{ end }}{{ end }}
                    </tbody>
                </table>
                </div>
            </article>
            {{ end }}

            <div class="page-actions" style="display:flex; gap:1rem; justify-content:flex-end;">
                <a href="/athletes/{{ .Athlete.ID }}/programs/generate" role="button" class="outline secondary" style="flex:1; text-align:center;">Back</a>
                <button type="submit" name="action" value="execute" data-confirm-submit="Import this program into the catalog?" style="flex:1;">Approve &amp; Import</button>
            </div>
        </form>
        {{ else }}
        <div class="page-actions">
            <a href="/athletes/{{ .Athlete.ID }}/programs/generate" role="button" class="outline secondary">Back</a>
        </div>
        {{ end }}
{{ end }}
