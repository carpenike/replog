{{ define "title" }}RepLog &mdash; AI Coach{{ end }}

{{ define "content" }}
        <div class="breadcrumb">
            <a href="/athletes/{{ .Athlete.ID }}">{{ .Athlete.Name }}</a> &rsaquo; AI Coach
        </div>

        <div class="page-header">
            <h1>Generate Program for {{ .Athlete.Name }}</h1>
        </div>

        {{ if .Error }}
        <article class="error-banner" aria-label="Error">
            <p>{{ .Error }}</p>
        </article>
        {{ end }}

        {{ if not .Configured }}
        <article class="warning-banner" aria-label="Warning">
            <p>AI Coach is not configured. An administrator must configure the AI Coach provider in
                <a href="/admin/settings">Settings</a> before generating programs.</p>
        </article>
        {{ else }}
        <form method="POST" action="/athletes/{{ .Athlete.ID }}/programs/generate"
              data-generate-submit>
            <input type="hidden" name="csrf_token" value="{{ .CSRFToken }}">

            <label for="program_name">Program Name</label>
            <input type="text" id="program_name" name="program_name"
                   value="{{ .SuggestedName }}" required>

            <div class="grid">
                <div>
                    <label for="num_days">Days per Week</label>
                    <select id="num_days" name="num_days">
                        {{ range $d := seq 1 7 }}
                        <option value="{{ $d }}" {{ if eq $d $.NumDays }}selected{{ end }}>{{ $d }}</option>
                        {{ end }}
                    </select>
                </div>
                <div>
                    <label for="num_weeks">Number of Weeks</label>
                    <input type="number" id="num_weeks" name="num_weeks"
                           value="{{ .NumWeeks }}" min="1" max="52">
                </div>
            </div>

            <fieldset>
                <label>
                    <input type="checkbox" name="is_loop" value="1" {{ if .IsLoop }}checked{{ end }}>
                    Looping program (repeats weekly)
                </label>
            </fieldset>

            <label>Focus Areas</label>
            <fieldset class="focus-areas">
                <label><input type="checkbox" name="focus_areas" value="strength" {{ if and $.SelectedFocusAreas (index $.SelectedFocusAreas "strength") }}checked{{ end }}> Strength</label>
                <label><input type="checkbox" name="focus_areas" value="power" {{ if and $.SelectedFocusAreas (index $.SelectedFocusAreas "power") }}checked{{ end }}> Power</label>
                <label><input type="checkbox" name="focus_areas" value="hypertrophy" {{ if and $.SelectedFocusAreas (index $.SelectedFocusAreas "hypertrophy") }}checked{{ end }}> Hypertrophy</label>
                <label><input type="checkbox" name="focus_areas" value="conditioning" {{ if and $.SelectedFocusAreas (index $.SelectedFocusAreas "conditioning") }}checked{{ end }}> Conditioning</label>
                <label><input type="checkbox" name="focus_areas" value="mobility" {{ if and $.SelectedFocusAreas (index $.SelectedFocusAreas "mobility") }}checked{{ end }}> Mobility</label>
                <label><input type="checkbox" name="focus_areas" value="sport_specific" {{ if and $.SelectedFocusAreas (index $.SelectedFocusAreas "sport_specific") }}checked{{ end }}> Sport-Specific</label>
            </fieldset>

            <label for="coach_directions">Coach Directions</label>
            <textarea id="coach_directions" name="coach_directions" rows="4"
                      placeholder="e.g. Start introducing hang cleans, pull back on carries...">{{ .CoachDirections }}</textarea>

            {{ if .ReferencePrograms }}
            <label>Reference Programs for AI Context</label>
            <fieldset class="reference-programs">
                {{ range .ReferencePrograms }}
                <label>
                    <input type="checkbox" name="reference_programs" value="{{ .ID }}"
                           {{ if not $.SelectedRefIDs }}checked{{ else }}{{ if index $.SelectedRefIDs .ID }}checked{{ end }}{{ end }}>
                    <span>{{ .Name }}{{ if .Description.Valid }}<br><small>{{ .Description.String }}</small>{{ end }}</span>
                </label>
                {{ end }}
            </fieldset>
            {{ end }}

            <div class="page-actions">
                <a href="/athletes/{{ .Athlete.ID }}" role="button" class="outline secondary">Cancel</a>
                <button type="submit" id="generate-btn" aria-busy="false">
                    Generate Program
                </button>
            </div>
            <span id="generate-indicator" class="htmx-indicator spinner">Generating program&hellip; This may take 10&ndash;30 seconds.</span>
        </form>

        {{ if .Context }}
        <details class="mt-xl">
            <summary>Athlete Context Sent to AI Coach</summary>
            <div class="mt-md">

                {{/* --- Profile --- */}}
                <h4>Athlete Profile</h4>
                <table>
                    <tbody>
                        <tr><th scope="row">Name</th><td>{{ .Context.Athlete.Name }}</td></tr>
                        {{ if .Context.Athlete.Tier }}<tr><th scope="row">Tier</th><td>{{ derefStr .Context.Athlete.Tier }}</td></tr>{{ end }}
                        {{ if .Context.Athlete.Goal }}<tr><th scope="row">Goal</th><td>{{ derefStr .Context.Athlete.Goal }}</td></tr>{{ end }}
                        {{ if .Context.Athlete.Notes }}<tr><th scope="row">Notes</th><td>{{ derefStr .Context.Athlete.Notes }}</td></tr>{{ end }}
                        <tr><th scope="row">Training Months</th><td>{{ .Context.Athlete.TrainingMonths }}</td></tr>
                        <tr><th scope="row">Total Workouts</th><td>{{ .Context.Athlete.TotalWorkouts }}</td></tr>
                        {{ if .Context.Athlete.LatestBW }}<tr><th scope="row">Latest Body Weight</th><td>{{ printf "%.1f" (deref .Context.Athlete.LatestBW) }} lbs</td></tr>{{ end }}
                    </tbody>
                </table>

                {{/* --- Equipment --- */}}
                <h4>Available Equipment</h4>
                {{ if .Context.Equipment }}
                <ul>
                    {{ range .Context.Equipment }}<li>{{ . }}</li>{{ end }}
                </ul>
                {{ else }}
                <p><em>No equipment assigned &mdash; only bodyweight exercises will be used.</em></p>
                {{ end }}

                {{/* --- Current Program --- */}}
                <h4>Current Program</h4>
                {{ if .Context.CurrentProgram }}
                <table>
                    <tbody>
                        <tr><th scope="row">Name</th><td>{{ .Context.CurrentProgram.Name }}</td></tr>
                        <tr><th scope="row">Structure</th><td>{{ .Context.CurrentProgram.NumWeeks }} weeks &times; {{ .Context.CurrentProgram.NumDays }} days{{ if .Context.CurrentProgram.IsLoop }} (looping){{ end }}</td></tr>
                        <tr><th scope="row">Start Date</th><td>{{ .Context.CurrentProgram.StartDate }}</td></tr>
                        <tr><th scope="row">Active</th><td>{{ if .Context.CurrentProgram.Active }}Yes{{ else }}No{{ end }}</td></tr>
                    </tbody>
                </table>
                {{ else }}
                <p><em>No current program.</em></p>
                {{ end }}

                {{/* --- Program History --- */}}
                {{ if .Context.ProgramHistory }}
                <h4>Program History ({{ len .Context.ProgramHistory }})</h4>
                <div class="table-scroll">
                <table>
                    <thead>
                        <tr><th scope="col">Name</th><th scope="col">Start Date</th><th scope="col">Structure</th><th scope="col">Status</th><th scope="col">Goal</th></tr>
                    </thead>
                    <tbody>
                        {{ range .Context.ProgramHistory }}
                        <tr>
                            <td>{{ .Name }}</td>
                            <td>{{ .StartDate }}</td>
                            <td>{{ .NumWeeks }}w &times; {{ .NumDays }}d{{ if .IsLoop }} (loop){{ end }}</td>
                            <td>{{ if .Active }}Active{{ else }}Completed{{ end }}</td>
                            <td>{{ if .Goal }}{{ derefStr .Goal }}{{ else }}&mdash;{{ end }}</td>
                        </tr>
                        {{ end }}
                    </tbody>
                </table>
                </div>
                {{ end }}

                {{/* --- Training Maxes --- */}}
                <h4>Training Maxes</h4>
                {{ if .Context.Performance.TrainingMaxes }}
                <table>
                    <thead>
                        <tr><th scope="col">Exercise</th><th scope="col">Weight</th><th scope="col">Date</th></tr>
                    </thead>
                    <tbody>
                        {{ range .Context.Performance.TrainingMaxes }}
                        <tr><td>{{ .Exercise }}</td><td>{{ printf "%.1f" .Weight }} lbs</td><td>{{ .EffectiveDate }}</td></tr>
                        {{ end }}
                    </tbody>
                </table>
                {{ else }}
                <p><em>No training maxes set.</em></p>
                {{ end }}

                {{/* --- Body Weights --- */}}
                {{ if .Context.Performance.BodyWeights }}
                <h4>Recent Body Weights</h4>
                <table>
                    <thead>
                        <tr><th scope="col">Date</th><th scope="col">Weight</th></tr>
                    </thead>
                    <tbody>
                        {{ range .Context.Performance.BodyWeights }}
                        <tr><td>{{ .Date }}</td><td>{{ printf "%.1f" .Weight }} lbs</td></tr>
                        {{ end }}
                    </tbody>
                </table>
                {{ end }}

                {{/* --- Coach Notes --- */}}
                {{ if .Context.CoachNotes }}
                <h4>Coach Notes &amp; Reviews</h4>
                <table>
                    <thead>
                        <tr><th scope="col">Date</th><th scope="col">Type</th><th scope="col">Content</th></tr>
                    </thead>
                    <tbody>
                        {{ range .Context.CoachNotes }}
                        <tr><td>{{ .Date }}</td><td>{{ .Type }}</td><td>{{ .Content }}</td></tr>
                        {{ end }}
                    </tbody>
                </table>
                {{ end }}

                {{/* --- Recent Workouts --- */}}
                {{ if .Context.RecentWorkouts }}
                <h4>Recent Workouts ({{ len .Context.RecentWorkouts }})</h4>
                {{ range .Context.RecentWorkouts }}
                <details>
                    <summary>{{ .Date }}{{ if .Notes }} &mdash; {{ derefStr .Notes }}{{ end }} ({{ len .Sets }} sets)</summary>
                    <div class="table-scroll">
                    <table>
                        <thead>
                            <tr><th scope="col">Exercise</th><th scope="col">Set</th><th scope="col">Reps</th><th scope="col">Weight</th><th scope="col">RPE</th></tr>
                        </thead>
                        <tbody>
                            {{ range .Sets }}
                            <tr>
                                <td>{{ .Exercise }}</td>
                                <td>{{ .SetNumber }}</td>
                                <td>{{ .Reps }}{{ if ne .RepType "reps" }} ({{ .RepType }}){{ end }}</td>
                                <td>{{ if .Weight }}{{ printf "%.1f" (deref .Weight) }}{{ else }}BW{{ end }}</td>
                                <td>{{ if .RPE }}{{ printf "%.1f" (deref .RPE) }}{{ else }}&mdash;{{ end }}</td>
                            </tr>
                            {{ end }}
                        </tbody>
                    </table>
                    </div>
                </details>
                {{ end }}
                {{ end }}

                {{/* --- Exercise Catalog --- */}}
                <h4>Exercise Catalog ({{ len .Context.ExerciseCatalog }} exercises)</h4>
                <details>
                    <summary>View all exercises</summary>
                    <table>
                        <thead>
                            <tr><th scope="col">Exercise</th><th scope="col">Tier</th><th scope="col">Compatible</th></tr>
                        </thead>
                        <tbody>
                            {{ range .Context.ExerciseCatalog }}
                            <tr>
                                <td>{{ .Name }}</td>
                                <td>{{ if .Tier }}{{ derefStr .Tier }}{{ else }}&mdash;{{ end }}</td>
                                <td>{{ if .Compatible }}&#10003;{{ else }}&#10007;{{ end }}</td>
                            </tr>
                            {{ end }}
                        </tbody>
                    </table>
                </details>

                {{/* --- Prior Templates --- */}}
                {{ if .Context.PriorTemplates }}
                <h4>Prior Program Templates</h4>
                <table>
                    <thead>
                        <tr><th scope="col">Name</th><th scope="col">Structure</th></tr>
                    </thead>
                    <tbody>
                        {{ range .Context.PriorTemplates }}
                        <tr><td>{{ .Name }}</td><td>{{ .NumWeeks }}w &times; {{ .NumDays }}d{{ if .IsLoop }} (loop){{ end }}</td></tr>
                        {{ end }}
                    </tbody>
                </table>
                {{ end }}

                {{/* --- Reference Programs --- */}}
                {{ if .Context.ReferencePrograms }}
                <h4>Reference Programs ({{ len .Context.ReferencePrograms }})</h4>
                <div class="table-scroll">
                <table>
                    <thead>
                        <tr><th scope="col">Name</th><th scope="col">Audience</th><th scope="col">Structure</th><th scope="col">Sets</th></tr>
                    </thead>
                    <tbody>
                        {{ range .Context.ReferencePrograms }}
                        <tr>
                            <td>{{ .Name }}</td>
                            <td>{{ .Audience }}</td>
                            <td>{{ .NumWeeks }}w &times; {{ .NumDays }}d{{ if .IsLoop }} (loop){{ end }}</td>
                            <td>{{ len .PrescribedSets }}</td>
                        </tr>
                        {{ end }}
                    </tbody>
                </table>
                </div>
                {{ end }}

                <div class="page-actions mt-md">
                    <a href="/athletes/{{ $.Athlete.ID }}/context.json" role="button" class="outline secondary" download>
                        Download Raw JSON
                    </a>
                </div>
            </div>
        </details>
        {{ end }}

        {{ end }}
{{ end }}
