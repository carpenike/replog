{{ define "title" }}RepLog — Workout {{ .Workout.Date }}{{ end }}

{{ define "content" }}
        <div class="breadcrumb">
            <a href="/athletes">Athletes</a> &rsaquo; <a href="/athletes/{{ .Athlete.ID }}">{{ .Athlete.Name }}</a> &rsaquo; <a href="/athletes/{{ .Athlete.ID }}/workouts">Workouts</a> &rsaquo; {{ .Workout.Date }}
        </div>

        <div class="page-header">
            <hgroup>
                <h1>{{ .Workout.Date }}{{ if .Review }} <span class="review-badge" data-status="{{ .Review.Status }}">{{ if eq .Review.Status "approved" }}✓ Reviewed{{ else }}⚠ Needs Work{{ end }}</span>{{ end }}</h1>
                <p>{{ .Athlete.Name }} &mdash; {{ .Workout.SetCount }} sets logged</p>
            </hgroup>
            {{ if .CanManage }}
            <div class="page-actions">
                <form method="POST" action="/athletes/{{ .Athlete.ID }}/workouts/{{ .Workout.ID }}/delete" class="inline"
                      hx-confirm="Delete this workout and all its sets?">
                    <button type="submit" class="outline contrast">Delete Workout</button>
                </form>
            </div>
            {{ end }}
        </div>

        <!-- Workout Notes -->
        <details>
            <summary>Session Notes</summary>
            <form method="POST" action="/athletes/{{ .Athlete.ID }}/workouts/{{ .Workout.ID }}/notes">
                <label for="notes">
                    <textarea id="notes" name="notes" rows="2" placeholder="Add session-level notes">{{ if .Workout.Notes.Valid }}{{ .Workout.Notes.String }}{{ end }}</textarea>
                </label>
                <button type="submit" class="outline secondary">Save Notes</button>
            </form>
        </details>

        <!-- Logged Sets -->
        {{ if .Groups }}
        <section>
            <h2>Logged Sets</h2>
            {{ range .Groups }}
            <details open class="exercise-group">
                <summary><strong>{{ .ExerciseName }}</strong> <span class="text-muted">({{ len .Sets }} sets)</span></summary>
                {{ $prev := index $.LastSession .ExerciseID }}{{ if $prev }}
                <details class="last-session">
                    <summary>Last time ({{ $prev.Date }})</summary>
                    <div class="last-session-sets">
                        {{ range $prev.Sets }}
                        <span class="last-set-chip">{{ .RepsLabel }}{{ if .Weight.Valid }}×{{ formatWeight .Weight.Float64 }}{{ end }}{{ if .RPE.Valid }} @{{ formatWeight .RPE.Float64 }}{{ end }}</span>
                        {{ end }}
                    </div>
                </details>
                {{ end }}
                <table class="striped">
                    <thead>
                        <tr>
                            <th scope="col">Set</th>
                            <th scope="col">Reps</th>
                            <th scope="col">Weight</th>
                            <th scope="col">RPE</th>
                            <th scope="col">Notes</th>
                            <th scope="col"></th>
                        </tr>
                    </thead>
                    <tbody>
                        {{ range .Sets }}
                        <tr{{ if .RPE.Valid }} data-rpe="{{ .RPE.Float64 }}"{{ end }}>
                            <td>{{ .SetNumber }}</td>
                            <td>{{ .RepsLabel }}</td>
                            <td>{{ if .Weight.Valid }}{{ formatWeight .Weight.Float64 }} {{ weightUnit $.Prefs }}{{ else }}<span class="text-muted">BW</span>{{ end }}</td>
                            <td>{{ if .RPE.Valid }}{{ .RPE.Float64 }}{{ else }}<span class="text-muted">—</span>{{ end }}</td>
                            <td>{{ if .Notes.Valid }}{{ .Notes.String }}{{ else }}<span class="text-muted">—</span>{{ end }}</td>
                            <td class="set-actions">
                                <a href="/athletes/{{ $.Athlete.ID }}/workouts/{{ $.Workout.ID }}/sets/{{ .ID }}/edit" role="button" class="outline secondary">Edit</a>
                                <form method="POST" action="/athletes/{{ $.Athlete.ID }}/workouts/{{ $.Workout.ID }}/sets/{{ .ID }}/delete" class="inline"
                                      hx-confirm="Delete this set?">
                                    <button type="submit" class="outline contrast">✕</button>
                                </form>
                            </td>
                        </tr>
                        {{ end }}
                    </tbody>
                </table>
                <!-- Quick-add: repeat another set for this exercise -->
                {{ $last := lastSet .Sets }}
                <form method="POST" action="/athletes/{{ $.Athlete.ID }}/workouts/{{ $.Workout.ID }}/sets" class="quick-add-form">
                    <input type="hidden" name="exercise_id" value="{{ .ExerciseID }}">
                    {{ if $last }}<input type="hidden" name="rep_type" value="{{ $last.RepType }}">{{ end }}
                    <div class="quick-add-grid">
                        <label class="field-sm">Reps
                            <input type="number" name="reps" min="1" required value="{{ if $last }}{{ $last.Reps }}{{ end }}" inputmode="numeric">
                        </label>
                        <label class="field-sm">Weight
                            <input type="number" name="weight" step="0.5" min="0" value="{{ if and $last $last.Weight.Valid }}{{ formatWeight $last.Weight.Float64 }}{{ end }}" inputmode="numeric">
                        </label>
                        <label class="field-sm">RPE
                            <input type="number" name="rpe" step="0.5" min="1" max="10" value="{{ if and $last $last.RPE.Valid }}{{ $last.RPE.Float64 }}{{ end }}" inputmode="numeric">
                        </label>
                        <button type="submit" class="outline secondary quick-add-btn">+ Add Set</button>
                    </div>
                </form>
            </details>
            {{ end }}
        </section>
        {{ end }}

        <!-- Rest Timer -->
        <div id="rest-timer" class="rest-timer" style="display:none;">
            <div class="timer-ring-container">
                <svg class="timer-ring" viewBox="0 0 120 120">
                    <circle class="timer-ring-bg" cx="60" cy="60" r="54" />
                    <circle class="timer-ring-progress" cx="60" cy="60" r="54" />
                </svg>
                <span class="timer-display">0:00</span>
            </div>
            <div class="timer-controls">
                <button type="button" class="timer-toggle outline secondary">Pause</button>
                <button type="button" class="timer-reset outline secondary">Reset</button>
                <button type="button" class="timer-dismiss outline contrast">✕</button>
            </div>
        </div>

        <!-- Coach Review Section -->
        {{ if .Review }}
        <section class="review-section">
            <h2>Coach Review</h2>
            <article class="review-card" data-status="{{ .Review.Status }}">
                <header>
                    <strong>{{ if eq .Review.Status "approved" }}✓ Approved{{ else }}⚠ Needs Work{{ end }}</strong>
                    <span class="text-muted"> — reviewed by {{ if .Review.CoachUsername.Valid }}{{ .Review.CoachUsername.String }}{{ else }}(deleted coach){{ end }}</span>
                </header>
                {{ if .Review.Notes.Valid }}
                <p>{{ .Review.Notes.String }}</p>
                {{ end }}
                {{ if .CanManage }}
                <footer>
                    <details>
                        <summary>Update Review</summary>
                        <form method="POST" action="/athletes/{{ .Athlete.ID }}/workouts/{{ .Workout.ID }}/review">
                            <fieldset role="group">
                                <label><input type="radio" name="status" value="approved"{{ if eq .Review.Status "approved" }} checked{{ end }}> Approved</label>
                                <label><input type="radio" name="status" value="needs_work"{{ if eq .Review.Status "needs_work" }} checked{{ end }}> Needs Work</label>
                            </fieldset>
                            <label for="review_notes">Feedback
                                <textarea id="review_notes" name="notes" rows="2" placeholder="Optional coaching feedback">{{ if .Review.Notes.Valid }}{{ .Review.Notes.String }}{{ end }}</textarea>
                            </label>
                            <div class="review-actions">
                                <button type="submit" class="outline secondary">Update Review</button>
                                <form method="POST" action="/athletes/{{ .Athlete.ID }}/workouts/{{ .Workout.ID }}/review/delete" class="inline"
                                      hx-confirm="Remove this review?">
                                    <button type="submit" class="outline contrast">Remove Review</button>
                                </form>
                            </div>
                        </form>
                    </details>
                </footer>
                {{ end }}
            </article>
        </section>
        {{ else if .CanManage }}
        <section class="review-section">
            <h2>Coach Review</h2>
            <form method="POST" action="/athletes/{{ .Athlete.ID }}/workouts/{{ .Workout.ID }}/review">
                <fieldset role="group">
                    <label><input type="radio" name="status" value="approved" checked> Approved</label>
                    <label><input type="radio" name="status" value="needs_work"> Needs Work</label>
                </fieldset>
                <label for="review_notes">Feedback
                    <textarea id="review_notes" name="notes" rows="2" placeholder="Optional coaching feedback"></textarea>
                </label>
                <button type="submit">Submit Review</button>
            </form>
        </section>
        {{ end }}

        <!-- Add Set Form -->
        <section>
            <h2>Log a Set</h2>

            {{ if .SetError }}
            <div class="alert alert-error" role="alert">{{ .SetError }}</div>
            {{ end }}

            {{ if and .Prescription .Prescription.Lines }}
            <!-- Program progress -->
            <div class="program-progress">
                <strong>{{ .Prescription.Program.TemplateName }}</strong> · Cycle {{ .Prescription.CycleNumber }}, Week {{ .Prescription.CurrentWeek }}, Day {{ .Prescription.CurrentDay }}
                <div class="progress-bar-segmented">
                    {{ $p := .Prescription }}
                    {{ range $w := seq 1 $p.Program.NumWeeks }}
                    <div class="progress-week{{ if le $w (subtract $p.CurrentWeek 1) }} completed{{ else if eq $w $p.CurrentWeek }} current{{ end }}">
                        {{ range $d := seq 1 $p.Program.NumDays }}
                        {{ $dayIdx := add (multiply (subtract $w 1) $p.Program.NumDays) $d }}
                        <div class="progress-day{{ if lt $dayIdx (add $p.CompletedInCycle 1) }} filled{{ end }}{{ if eq $dayIdx (add $p.CompletedInCycle 1) }} today{{ end }}" title="Week {{ $w }}, Day {{ $d }}"></div>
                        {{ end }}
                    </div>
                    {{ end }}
                </div>
                <span class="progress-label">{{ $p.CompletedInCycle }}/{{ $p.TotalInCycle }} sessions</span>
            </div>

            <!-- Per-set scaffold: one form row per prescribed set -->
            {{ range $line := .Prescription.Lines }}
            {{ $loggedCount := index $.LoggedSetCounts $line.ExerciseID }}
            {{ $totalSets := len $line.Sets }}
            <details{{ if lt $loggedCount $totalSets }} open{{ end }} class="scaffold-exercise">
                <summary>
                    <strong>{{ $line.ExerciseName }}</strong>
                    {{ $tm := index $.TMByExercise $line.ExerciseID }}{{ if $tm }}<span class="text-muted">TM: {{ formatWeight $tm.Weight }} {{ weightUnit $.Prefs }}</span>{{ end }}
                    <span class="scaffold-progress{{ if ge $loggedCount $totalSets }} complete{{ end }}">{{ $loggedCount }}/{{ $totalSets }} sets</span>
                </summary>
                {{ if ge $loggedCount $totalSets }}
                <p class="scaffold-complete">&#10003; All sets complete</p>
                {{ else }}
                {{ range $i, $s := $line.Sets }}
                {{ if ge $i $loggedCount }}
                <form method="POST" action="/athletes/{{ $.Athlete.ID }}/workouts/{{ $.Workout.ID }}/sets" class="scaffold-set-form">
                    <input type="hidden" name="exercise_id" value="{{ $line.ExerciseID }}">
                    <input type="hidden" name="rep_type" value="{{ $s.RepType }}">
                    <div class="scaffold-grid">
                        <span class="scaffold-target">Set {{ $s.SetNumber }}: {{ $s.RepsLabel }}{{ if $s.PercentageLabel }} @ {{ $s.PercentageLabel }}{{ end }}{{ if $s.TargetWeightLabel }} &rarr; {{ $s.TargetWeightLabel }} {{ weightUnit $.Prefs }}{{ end }}{{ if $s.Notes.Valid }} <span class="text-muted">({{ $s.Notes.String }})</span>{{ end }}</span>
                        <label class="field-sm">Reps
                            <input type="number" name="reps" min="1" required value="{{ if $s.Reps.Valid }}{{ $s.Reps.Int64 }}{{ end }}" inputmode="numeric"{{ if not $s.Reps.Valid }} placeholder="AMRAP"{{ end }}>
                        </label>
                        <label class="field-sm">Weight
                            <input type="number" name="weight" step="0.5" min="0" value="{{ $s.TargetWeightLabel }}" inputmode="numeric" placeholder="{{ weightUnit $.Prefs }}">
                        </label>
                        <label class="field-sm">RPE
                            <input type="number" name="rpe" step="0.5" min="1" max="10" inputmode="numeric" placeholder="1-10">
                        </label>
                        <button type="submit" class="outline secondary scaffold-log-btn">Log</button>
                    </div>
                </form>
                {{ end }}
                {{ end }}
                {{ end }}
            </details>
            {{ end }}

            <!-- Fallback: add unscripted / accessory sets -->
            <button type="button" class="outline secondary unscripted-toggle" onclick="var f=document.getElementById('unscripted-form');f.hidden=!f.hidden;this.hidden=true">+ Add Unscripted Set</button>
            <div id="unscripted-form" hidden>
            {{ else if .Assigned }}
            <details>
                <summary>Prescribed Exercises</summary>
                <table class="striped">
                    <thead>
                        <tr>
                            <th scope="col">Exercise</th>
                            <th scope="col">Target Reps</th>
                            <th scope="col">Training Max</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{ range .Assigned }}
                        <tr>
                            <td>{{ .ExerciseName }}</td>
                            <td>{{ if .TargetReps.Valid }}{{ .TargetReps.Int64 }}{{ else }}<span class="text-muted">—</span>{{ end }}</td>
                            <td>{{ $tm := index $.TMByExercise .ExerciseID }}{{ if $tm }}{{ formatWeight $tm.Weight }} {{ weightUnit $.Prefs }}{{ else }}<span class="text-muted">—</span>{{ end }}</td>
                        </tr>
                        {{ end }}
                    </tbody>
                </table>
            </details>
            {{ end }}

            <form method="POST" action="/athletes/{{ .Athlete.ID }}/workouts/{{ .Workout.ID }}/sets">
                <div class="log-set-grid">
                    <label for="exercise_id">Exercise
                        <select id="exercise_id" name="exercise_id" required>
                            <option value="">— Select —</option>
                            {{ if .Assigned }}
                            <optgroup label="Assigned">
                                {{ range .Assigned }}
                                <option value="{{ .ExerciseID }}"{{ if eq .ExerciseID $.SelectedExerciseID }} selected{{ end }}>{{ .ExerciseName }}{{ if .TargetReps.Valid }} ({{ .TargetReps.Int64 }} reps){{ end }}{{ $tm := index $.TMByExercise .ExerciseID }}{{ if $tm }} — TM: {{ formatWeight $tm.Weight }} {{ weightUnit $.Prefs }}{{ end }}</option>
                                {{ end }}
                            </optgroup>
                            {{ end }}
                            {{ if .Unassigned }}
                            <optgroup label="All Exercises">
                                {{ range .Unassigned }}
                                <option value="{{ .ID }}"{{ if eq .ID $.SelectedExerciseID }} selected{{ end }}>{{ .Name }}</option>
                                {{ end }}
                            </optgroup>
                            {{ end }}
                        </select>
                    </label>
                    <label for="sets" class="field-sm">Sets
                        <input type="number" id="sets" name="sets" min="1" max="20" value="1" inputmode="numeric">
                    </label>
                    <label for="reps" class="field-sm">Reps
                        <input type="number" id="reps" name="reps" min="1" required placeholder="0" inputmode="numeric">
                    </label>
                    <label for="weight" class="field-sm">Weight ({{ weightUnit .Prefs }})
                        <input type="number" id="weight" name="weight" step="0.5" min="0" placeholder="{{ weightUnit .Prefs }}" inputmode="numeric">
                    </label>
                    <label for="rpe" class="field-sm">RPE
                        <input type="number" id="rpe" name="rpe" step="0.5" min="1" max="10" placeholder="1-10" inputmode="numeric">
                    </label>
                    <label for="rep_type" class="field-sm">Rep Type
                        <select id="rep_type" name="rep_type">
                            <option value="reps">Reps</option>
                            <option value="each_side">Each Side</option>
                            <option value="seconds">Seconds</option>
                        </select>
                    </label>
                </div>
                <label for="set_notes">Notes
                    <input type="text" id="set_notes" name="notes" placeholder="Optional per-set note">
                </label>
                <button type="submit" aria-busy="false">Log Set</button>
            </form>

            {{ if and .Prescription .Prescription.Lines }}
            </div>
            {{ end }}
        </section>
        <script src="/static/js/rest-timer.js"></script>
{{ end }}
