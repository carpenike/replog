{{ define "title" }}RepLog — Workout {{ .Workout.Date }}{{ end }}

{{ define "content" }}
        <div class="breadcrumb">
            <a href="/athletes">Athletes</a> &rsaquo; <a href="/athletes/{{ .Athlete.ID }}">{{ .Athlete.Name }}</a> &rsaquo; <a href="/athletes/{{ .Athlete.ID }}/workouts">Workouts</a> &rsaquo; {{ .Workout.Date }}
        </div>

        <div class="page-header">
            <hgroup>
                <h1>{{ .Workout.Date }}</h1>
                <p>{{ .Athlete.Name }} &mdash; {{ .Workout.SetCount }} sets logged</p>
            </hgroup>
            {{ if .User.IsCoach }}
            <div class="page-actions">
                <form method="POST" action="/athletes/{{ .Athlete.ID }}/workouts/{{ .Workout.ID }}/delete" class="inline"
                      hx-confirm="Delete this workout and all its sets?">
                    <button type="submit" class="outline contrast">Delete Workout</button>
                </form>
            </div>
            {{ end }}
        </div>

        <!-- Workout Notes -->
        <details>
            <summary>Session Notes</summary>
            <form method="POST" action="/athletes/{{ .Athlete.ID }}/workouts/{{ .Workout.ID }}/notes">
                <label for="notes">
                    <textarea id="notes" name="notes" rows="2" placeholder="Add session-level notes">{{ if .Workout.Notes.Valid }}{{ .Workout.Notes.String }}{{ end }}</textarea>
                </label>
                <button type="submit" class="outline secondary">Save Notes</button>
            </form>
        </details>

        <!-- Logged Sets -->
        {{ if .Groups }}
        <section>
            <h2>Logged Sets</h2>
            {{ range .Groups }}
            <article>
                <header><strong>{{ .ExerciseName }}</strong></header>
                {{ $prev := index $.LastSession .ExerciseID }}{{ if $prev }}
                <details class="last-session">
                    <summary>Last time ({{ $prev.Date }})</summary>
                    <div class="last-session-sets">
                        {{ range $prev.Sets }}
                        <span class="last-set-chip">{{ .Reps }}{{ if .Weight.Valid }}×{{ formatWeight .Weight.Float64 }}{{ end }}{{ if .RPE.Valid }} @{{ formatWeight .RPE.Float64 }}{{ end }}</span>
                        {{ end }}
                    </div>
                </details>
                {{ end }}
                <table class="striped">
                    <thead>
                        <tr>
                            <th scope="col">Set</th>
                            <th scope="col">Reps</th>
                            <th scope="col">Weight</th>
                            <th scope="col">RPE</th>
                            <th scope="col">Notes</th>
                            <th scope="col"></th>
                        </tr>
                    </thead>
                    <tbody>
                        {{ range .Sets }}
                        <tr{{ if .RPE.Valid }} data-rpe="{{ .RPE.Float64 }}"{{ end }}>
                            <td>{{ .SetNumber }}</td>
                            <td>{{ .Reps }}</td>
                            <td>{{ if .Weight.Valid }}{{ formatWeight .Weight.Float64 }} {{ weightUnit $.Prefs }}{{ else }}<span class="text-muted">BW</span>{{ end }}</td>
                            <td>{{ if .RPE.Valid }}{{ .RPE.Float64 }}{{ else }}<span class="text-muted">—</span>{{ end }}</td>
                            <td>{{ if .Notes.Valid }}{{ .Notes.String }}{{ else }}<span class="text-muted">—</span>{{ end }}</td>
                            <td class="set-actions">
                                <a href="/athletes/{{ $.Athlete.ID }}/workouts/{{ $.Workout.ID }}/sets/{{ .ID }}/edit" role="button" class="outline secondary">Edit</a>
                                <form method="POST" action="/athletes/{{ $.Athlete.ID }}/workouts/{{ $.Workout.ID }}/sets/{{ .ID }}/delete" class="inline"
                                      hx-confirm="Delete this set?">
                                    <button type="submit" class="outline contrast">✕</button>
                                </form>
                            </td>
                        </tr>
                        {{ end }}
                    </tbody>
                </table>
                <!-- Quick-add: repeat another set for this exercise -->
                {{ $last := lastSet .Sets }}
                <form method="POST" action="/athletes/{{ $.Athlete.ID }}/workouts/{{ $.Workout.ID }}/sets" class="quick-add-form">
                    <input type="hidden" name="exercise_id" value="{{ .ExerciseID }}">
                    <div class="quick-add-grid">
                        <label class="field-sm">Reps
                            <input type="number" name="reps" min="1" required value="{{ if $last }}{{ $last.Reps }}{{ end }}" inputmode="numeric">
                        </label>
                        <label class="field-sm">Weight
                            <input type="number" name="weight" step="0.5" min="0" value="{{ if and $last $last.Weight.Valid }}{{ formatWeight $last.Weight.Float64 }}{{ end }}" inputmode="numeric">
                        </label>
                        <label class="field-sm">RPE
                            <input type="number" name="rpe" step="0.5" min="1" max="10" value="{{ if and $last $last.RPE.Valid }}{{ $last.RPE.Float64 }}{{ end }}" inputmode="numeric">
                        </label>
                        <button type="submit" class="outline secondary quick-add-btn">+ Add Set</button>
                    </div>
                </form>
            </article>
            {{ end }}
        </section>
        {{ end }}

        <!-- Rest Timer -->
        <div id="rest-timer" class="rest-timer" style="display:none;">
            <div class="timer-ring-container">
                <svg class="timer-ring" viewBox="0 0 120 120">
                    <circle class="timer-ring-bg" cx="60" cy="60" r="54" />
                    <circle class="timer-ring-progress" cx="60" cy="60" r="54" />
                </svg>
                <span class="timer-display">0:00</span>
            </div>
            <div class="timer-controls">
                <button type="button" class="timer-toggle outline secondary">Pause</button>
                <button type="button" class="timer-reset outline secondary">Reset</button>
                <button type="button" class="timer-dismiss outline contrast">✕</button>
            </div>
        </div>

        <!-- Add Set Form -->
        <section>
            <h2>Log a Set</h2>

            {{ if .SetError }}
            <div class="alert alert-error" role="alert">{{ .SetError }}</div>
            {{ end }}

            {{ if and .Prescription .Prescription.Lines }}
            <details open>
                <summary>Today's Prescription — {{ .Prescription.Program.TemplateName }} · Cycle {{ .Prescription.CycleNumber }}, Week {{ .Prescription.CurrentWeek }}, Day {{ .Prescription.CurrentDay }}</summary>
                <div class="program-progress">
                    <div class="progress-bar-segmented">
                        {{ $p := .Prescription }}
                        {{ range $w := seq 1 $p.Program.NumWeeks }}
                        <div class="progress-week{{ if le $w (subtract $p.CurrentWeek 1) }} completed{{ else if eq $w $p.CurrentWeek }} current{{ end }}">
                            {{ range $d := seq 1 $p.Program.NumDays }}
                            {{ $dayIdx := add (multiply (subtract $w 1) $p.Program.NumDays) $d }}
                            <div class="progress-day{{ if lt $dayIdx (add $p.CompletedInCycle 1) }} filled{{ end }}{{ if eq $dayIdx (add $p.CompletedInCycle 1) }} today{{ end }}" title="Week {{ $w }}, Day {{ $d }}"></div>
                            {{ end }}
                        </div>
                        {{ end }}
                    </div>
                    <span class="progress-label">{{ $p.CompletedInCycle }}/{{ $p.TotalInCycle }} sessions</span>
                </div>
                <table class="striped">
                    <thead>
                        <tr>
                            <th scope="col">Exercise</th>
                            <th scope="col">Sets × Reps</th>
                            <th scope="col">% of TM</th>
                            <th scope="col">Target Weight</th>
                            <th scope="col"></th>
                        </tr>
                    </thead>
                    <tbody>
                        {{ range .Prescription.Lines }}
                        <tr>
                            <td>{{ .ExerciseName }}</td>
                            <td>{{ .SetsSummary }}</td>
                            <td>{{ if .PercentageLabel }}{{ .PercentageLabel }}{{ else }}<span class="text-muted">—</span>{{ end }}</td>
                            <td>{{ if .TargetWeightLabel }}{{ .TargetWeightLabel }} {{ weightUnit $.Prefs }}{{ else }}<span class="text-muted">—</span>{{ end }}</td>
                            <td>
                                <button type="button" class="outline secondary prefill-btn"
                                    data-exercise-id="{{ .ExerciseID }}"
                                    data-reps="{{ if .Sets }}{{ (index .Sets 0).RepsLabel }}{{ end }}"
                                    data-weight="{{ .TargetWeightLabel }}">Load</button>
                            </td>
                        </tr>
                        {{ end }}
                    </tbody>
                </table>
            </details>
            {{ else if .Assigned }}
            <details>
                <summary>Prescribed Exercises</summary>
                <table class="striped">
                    <thead>
                        <tr>
                            <th scope="col">Exercise</th>
                            <th scope="col">Target Reps</th>
                            <th scope="col">Training Max</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{ range .Assigned }}
                        <tr>
                            <td>{{ .ExerciseName }}</td>
                            <td>{{ if .TargetReps.Valid }}{{ .TargetReps.Int64 }}{{ else }}<span class="text-muted">—</span>{{ end }}</td>
                            <td>{{ $tm := index $.TMByExercise .ExerciseID }}{{ if $tm }}{{ formatWeight $tm.Weight }} {{ weightUnit $.Prefs }}{{ else }}<span class="text-muted">—</span>{{ end }}</td>
                        </tr>
                        {{ end }}
                    </tbody>
                </table>
            </details>
            {{ end }}

            <form method="POST" action="/athletes/{{ .Athlete.ID }}/workouts/{{ .Workout.ID }}/sets">
                <div class="log-set-grid">
                    <label for="exercise_id">Exercise
                        <select id="exercise_id" name="exercise_id" required>
                            <option value="">— Select —</option>
                            {{ if .Assigned }}
                            <optgroup label="Assigned">
                                {{ range .Assigned }}
                                <option value="{{ .ExerciseID }}"{{ if eq .ExerciseID $.SelectedExerciseID }} selected{{ end }}>{{ .ExerciseName }}{{ if .TargetReps.Valid }} ({{ .TargetReps.Int64 }} reps){{ end }}{{ $tm := index $.TMByExercise .ExerciseID }}{{ if $tm }} — TM: {{ formatWeight $tm.Weight }} {{ weightUnit $.Prefs }}{{ end }}</option>
                                {{ end }}
                            </optgroup>
                            {{ end }}
                            {{ if .Unassigned }}
                            <optgroup label="All Exercises">
                                {{ range .Unassigned }}
                                <option value="{{ .ID }}"{{ if eq .ID $.SelectedExerciseID }} selected{{ end }}>{{ .Name }}</option>
                                {{ end }}
                            </optgroup>
                            {{ end }}
                        </select>
                    </label>
                    <label for="sets" class="field-sm">Sets
                        <input type="number" id="sets" name="sets" min="1" max="20" value="1" inputmode="numeric">
                    </label>
                    <label for="reps" class="field-sm">Reps
                        <input type="number" id="reps" name="reps" min="1" required placeholder="0" inputmode="numeric">
                    </label>
                    <label for="weight" class="field-sm">Weight ({{ weightUnit .Prefs }})
                        <input type="number" id="weight" name="weight" step="0.5" min="0" placeholder="{{ weightUnit .Prefs }}" inputmode="numeric">
                    </label>
                    <label for="rpe" class="field-sm">RPE
                        <input type="number" id="rpe" name="rpe" step="0.5" min="1" max="10" placeholder="1-10" inputmode="numeric">
                    </label>
                </div>
                <label for="set_notes">Notes
                    <input type="text" id="set_notes" name="notes" placeholder="Optional per-set note">
                </label>
                <button type="submit" aria-busy="false">Log Set</button>
            </form>
        </section>
        <script>
        // Pre-fill the add-set form from prescription "Load" buttons.
        document.addEventListener("click", function(e) {
            var btn = e.target.closest(".prefill-btn");
            if (!btn) return;

            var exerciseId = btn.getAttribute("data-exercise-id");
            var reps = btn.getAttribute("data-reps");
            var weight = btn.getAttribute("data-weight");

            var exerciseSelect = document.getElementById("exercise_id");
            if (exerciseSelect && exerciseId) {
                exerciseSelect.value = exerciseId;
            }

            var repsInput = document.getElementById("reps");
            if (repsInput && reps && reps !== "AMRAP") {
                repsInput.value = reps;
            } else if (repsInput && reps === "AMRAP") {
                repsInput.value = "";
                repsInput.focus();
            }

            var weightInput = document.getElementById("weight");
            if (weightInput && weight) {
                weightInput.value = weight;
            }

            // Scroll the form into view.
            exerciseSelect.closest("form").scrollIntoView({ behavior: "smooth", block: "center" });
        });
        </script>
        <script src="/static/js/rest-timer.js"></script>
{{ end }}
