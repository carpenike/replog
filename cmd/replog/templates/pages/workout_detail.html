{{ define "title" }}RepLog — Workout {{ .Workout.Date }}{{ end }}

{{ define "content" }}
        <div class="breadcrumb">
            <a href="/athletes">Athletes</a> &rsaquo; <a href="/athletes/{{ .Athlete.ID }}">{{ .Athlete.Name }}</a> &rsaquo; <a href="/athletes/{{ .Athlete.ID }}/workouts">Workouts</a> &rsaquo; {{ .Workout.Date }}
        </div>

        <div class="page-header">
            <h1>{{ .Workout.Date }}</h1>
            {{ if .User.IsCoach }}
            <div class="page-actions">
                <form method="POST" action="/athletes/{{ .Athlete.ID }}/workouts/{{ .Workout.ID }}/delete" class="inline-form"
                      hx-confirm="Delete this workout and all its sets?">
                    <button type="submit" class="btn btn-danger">Delete Workout</button>
                </form>
            </div>
            {{ end }}
        </div>

        <p>{{ .Athlete.Name }} &mdash; {{ .Workout.SetCount }} sets logged</p>

        <!-- Workout Notes -->
        <section class="section">
            <details class="notes-toggle">
                <summary>Session Notes</summary>
                <form method="POST" action="/athletes/{{ .Athlete.ID }}/workouts/{{ .Workout.ID }}/notes" class="notes-form">
                    <div class="form-group">
                        <textarea name="notes" rows="2" placeholder="Add session-level notes">{{ if .Workout.Notes.Valid }}{{ .Workout.Notes.String }}{{ end }}</textarea>
                    </div>
                    <button type="submit" class="btn btn-small">Save Notes</button>
                </form>
            </details>
        </section>

        <!-- Logged Sets -->
        {{ if .Groups }}
        <section class="section">
            <h2>Logged Sets</h2>
            {{ range .Groups }}
            <div class="exercise-group">
                <h3>{{ .ExerciseName }}</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th scope="col">Set</th>
                            <th scope="col">Reps</th>
                            <th scope="col">Weight</th>
                            <th scope="col">Notes</th>
                            <th scope="col"></th>
                        </tr>
                    </thead>
                    <tbody>
                        {{ range .Sets }}
                        <tr>
                            <td>{{ .SetNumber }}</td>
                            <td>{{ .Reps }}</td>
                            <td>{{ if .Weight.Valid }}{{ .Weight.Float64 }} lbs{{ else }}<span class="text-muted">BW</span>{{ end }}</td>
                            <td>{{ if .Notes.Valid }}{{ .Notes.String }}{{ else }}<span class="text-muted">—</span>{{ end }}</td>
                            <td class="set-actions">
                                <a href="/athletes/{{ $.Athlete.ID }}/workouts/{{ $.Workout.ID }}/sets/{{ .ID }}/edit" class="btn btn-small">Edit</a>
                                <form method="POST" action="/athletes/{{ $.Athlete.ID }}/workouts/{{ $.Workout.ID }}/sets/{{ .ID }}/delete" class="inline-form"
                                      hx-confirm="Delete this set?">
                                    <button type="submit" class="btn btn-small btn-danger">✕</button>
                                </form>
                            </td>
                        </tr>
                        {{ end }}
                    </tbody>
                </table>
            </div>
            {{ end }}
        </section>
        {{ end }}

        <!-- Add Set Form -->
        <section class="section">
            <h2>Log a Set</h2>

            {{ if .Assigned }}
            <details class="notes-toggle">
                <summary>Prescribed Exercises</summary>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th scope="col">Exercise</th>
                            <th scope="col">Target Reps</th>
                            <th scope="col">Training Max</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{ range .Assigned }}
                        <tr>
                            <td>{{ .ExerciseName }}</td>
                            <td>{{ if .TargetReps.Valid }}{{ .TargetReps.Int64 }}{{ else }}<span class="text-muted">—</span>{{ end }}</td>
                            <td>{{ $tm := index $.TMByExercise .ExerciseID }}{{ if $tm }}{{ $tm.Weight }} lbs{{ else }}<span class="text-muted">—</span>{{ end }}</td>
                        </tr>
                        {{ end }}
                    </tbody>
                </table>
            </details>
            {{ end }}

            <form method="POST" action="/athletes/{{ .Athlete.ID }}/workouts/{{ .Workout.ID }}/sets" class="add-set-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="exercise_id">Exercise</label>
                        <select id="exercise_id" name="exercise_id" required>
                            <option value="">— Select —</option>
                            {{ if .Assigned }}
                            <optgroup label="Assigned">
                                {{ range .Assigned }}
                                <option value="{{ .ExerciseID }}">{{ .ExerciseName }}{{ if .TargetReps.Valid }} ({{ .TargetReps.Int64 }} reps){{ end }}{{ $tm := index $.TMByExercise .ExerciseID }}{{ if $tm }} — TM: {{ $tm.Weight }} lbs{{ end }}</option>
                                {{ end }}
                            </optgroup>
                            {{ end }}
                            {{ if .Unassigned }}
                            <optgroup label="All Exercises">
                                {{ range .Unassigned }}
                                <option value="{{ .ID }}">{{ .Name }}</option>
                                {{ end }}
                            </optgroup>
                            {{ end }}
                        </select>
                    </div>
                    <div class="form-group form-group-sm">
                        <label for="reps">Reps</label>
                        <input type="number" id="reps" name="reps" min="1" required placeholder="0">
                    </div>
                    <div class="form-group form-group-sm">
                        <label for="weight">Weight</label>
                        <input type="number" id="weight" name="weight" step="0.5" min="0" placeholder="lbs">
                    </div>
                </div>
                <div class="form-group">
                    <label for="set_notes">Notes</label>
                    <input type="text" id="set_notes" name="notes" placeholder="Optional per-set note">
                </div>
                <button type="submit" class="btn btn-primary">Log Set</button>
            </form>
        </section>
{{ end }}
